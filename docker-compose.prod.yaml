
services:
  silencecut-api:
    image: visionugc.fr/silencecut-api:latest
    container_name: silencecut-api
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.silencecut-api.rule=Host(`yanacode.fr`) && PathPrefix(`/silencecutapi`)"
      - "traefik.http.routers.silencecut-api.entrypoints=websecure"
      - "traefik.http.routers.silencecut-api.tls=true"
      - "traefik.http.routers.silencecut-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.silencecut-api.loadbalancer.server.port=3333"
      # Middleware pour supprimer le pr√©fixe /silencecutapi
      - "traefik.http.middlewares.silencecut-api-stripprefix.stripprefix.prefixes=/silencecutapi"
      - "traefik.http.routers.silencecut-api.middlewares=silencecut-api-stripprefix"
    environment:
      NODE_ENV: production
      PORT: 3333
      HOST: 0.0.0.0
      APP_KEY: ${APP_KEY}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Database
      DB_HOST: ${DB_HOST:-silencecut-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-silencecut_admin}
      DB_PASSWORD: ${DB_PASSWORD:-my_silencecut_pass}
      DB_DATABASE: ${DB_DATABASE:-silencecut}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      VIDEO_STORAGE_PATH: ${VIDEO_STORAGE_PATH:-/tmp/videos}
      VIDEO_MAX_SIZE: ${VIDEO_MAX_SIZE:-262144000}
      # Video processing settings - Stricter = fewer silences = faster processing
      SILENCE_THRESHOLD: ${SILENCE_THRESHOLD:--40}  # Very strict threshold (only very quiet parts)
      SILENCE_DURATION: ${SILENCE_DURATION:-1.0}   # 3 seconds minimum (ignore short pauses)
      FILE_CLEANUP_INTERVAL: ${FILE_CLEANUP_INTERVAL:-15}
      MAX_CONCURRENT_JOBS: ${MAX_CONCURRENT_JOBS:-2}
      VIDEO_MAX_SIZE_IN_MB: ${VIDEO_MAX_SIZE_IN_MB:-250}
      MAX_SILENCES: ${MAX_SILENCES:-10}
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-https://silencecut.com,http://localhost:3000}

      # Session
      SESSION_DRIVER: cookie

      TZ: Europe/Paris
    depends_on:
      - silencecut-db
    networks:
      - web

  silencecut-db:
    image: postgres:15
    container_name: silencecut-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE:-silencecut}
      POSTGRES_USER: ${DB_USER:-silencecut_admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-my_silencecut_pass}
    volumes:
      - silencecut_db_data:/var/lib/postgresql/data
    networks:
      - web

volumes:
  silencecut_db_data:

networks:
  web:
    external: true
